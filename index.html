<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Training Log</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,Helvetica,Arial,sans-serif;background:#fff;color:#111;min-height:100vh;max-width:480px;margin:0 auto;padding:0;padding-bottom:80px}
input[type=number]{-moz-appearance:textfield}
input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
.tabs{display:flex;border-bottom:2px solid #ccc;position:sticky;top:0;background:#fff;z-index:10}
.tab{flex:1;text-align:center;padding:14px 0;font-size:14px;font-weight:700;color:#999;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;letter-spacing:1px}
.tab.active{color:#111;border-bottom-color:#111}
.page{padding:16px;padding-bottom:160px}
.hh{text-align:center;padding:20px 0 16px;border-bottom:1px solid #ccc;margin-bottom:24px}
.ht{font-size:26px;font-weight:800;letter-spacing:6px;color:#000}
.hs{font-size:11px;letter-spacing:5px;color:#777;margin-top:4px}
.hd{font-size:13px;color:#777;margin-top:12px}
.dc{background:#f7f7f7;border:1px solid #ccc;border-radius:8px;padding:16px;margin-bottom:12px}
.dch{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.dcn{font-size:18px;font-weight:700;color:#000}
.dcl{font-size:13px;color:#666;background:#e5e5e5;padding:2px 8px;border-radius:4px}
.dce{font-size:13px;color:#555;line-height:1.7}
.pi{color:#1a6b1a;margin-right:4px;font-weight:700}
.pinfo{font-size:11px;color:#1a6b1a;margin-top:8px;letter-spacing:1px;text-transform:uppercase}
.inp{font-size:11px;color:#9a7000;margin-top:6px;letter-spacing:1px;text-transform:uppercase}
.lwd{font-size:11px;color:#888;margin-top:4px}
.hdr{display:flex;align-items:center;gap:12px;padding-bottom:16px;border-bottom:1px solid #ccc;margin-bottom:16px}
.bb{background:none;border:none;color:#666;font-size:16px;cursor:pointer;font-family:inherit;padding:4px 0}
.pt{font-size:20px;font-weight:700;color:#000}
.dt{font-size:13px;color:#666;font-weight:400}
.wd{font-size:12px;color:#666;margin-left:auto}
.tb{background:#fff8e8;border:1px solid #d4b860;border-radius:8px;padding:10px 16px;display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.tt{font-size:22px;font-weight:700;color:#9a7000}
.tc{background:none;border:none;color:#888;font-size:18px;cursor:pointer}
.ec{background:#f7f7f7;border:1px solid #ccc;border-radius:8px;padding:12px;margin-bottom:10px;border-left:3px solid #ccc}
.ec.pa{border-left-color:#1a6b1a;background:#eef6ee}
.ec.pb{border-left-color:#1a1a6b;background:#eeeef6}
.ec.pc{border-left-color:#6b1a1a;background:#f6eeee}
.ec.done{background:#e8f5e8;border-color:#80b880;border-left-color:#1a6b1a}
.ec.collapsed{padding:8px 12px;margin-bottom:6px}
.enr{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.pbg{font-size:10px;font-weight:800;padding:2px 6px;border-radius:3px;letter-spacing:1px;display:inline-block}
.pbg.a{background:#c0dcc0;color:#1a6b1a}
.pbg.b{background:#c0c0dc;color:#1a1a6b}
.pbg.c{background:#dcc0c0;color:#6b1a1a}
.en{font-size:15px;font-weight:600;color:#111}
.lp{font-size:12px;color:#777;margin-bottom:4px}
.ps{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}
.pst{font-size:12px;color:#888;background:#e8e8e8;padding:2px 6px;border-radius:3px}
.nr{margin-bottom:8px}
.nt{background:none;border:none;font-size:12px;color:#999;font-family:inherit;cursor:pointer;padding:2px 0}
.ni{background:#fff;border:1px solid #bbb;border-radius:4px;color:#7a5d10;font-size:13px;padding:6px 8px;width:100%;font-family:inherit;outline:none;margin-top:4px;resize:none;height:36px;line-height:1.4}
.ni:focus{border-color:#888}
.nd{font-size:12px;color:#7a5d10;font-style:italic;line-height:1.4}
.sr{display:flex;align-items:center;gap:8px;margin-bottom:5px}
.sr.checked{opacity:0.5}
.sn{font-size:12px;color:#999;width:16px;text-align:center}
.si{background:#fff;border:1px solid #bbb;border-radius:4px;color:#111;font-size:15px;padding:8px 8px;width:65px;font-family:inherit;text-align:center;outline:none}
.si:focus{border-color:#666}
.ss{color:#999;font-size:14px}
.cb{width:22px;height:22px;accent-color:#1a6b1a;cursor:pointer}
.cline{display:flex;align-items:center;gap:6px;cursor:pointer;flex-wrap:wrap}
.cline .en{font-size:14px}
.ctag{font-size:11px;color:#1a6b1a;background:#d0e8d0;padding:1px 5px;border-radius:3px}
.carrow{font-size:11px;color:#888;margin-left:auto}
.bar{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #ccc;padding:12px 16px;max-width:480px;margin:0 auto}
.tbs{display:flex;gap:8px;justify-content:center;margin-bottom:8px}
.tbtn{background:#f0f0f0;border:1px solid #bbb;border-radius:6px;color:#444;font-size:13px;padding:8px 16px;cursor:pointer;font-family:inherit}
.brow{display:flex;gap:8px}
.fb{background:#e0f0e0;border:1px solid #80b880;border-radius:8px;color:#1a6b1a;font-size:14px;font-weight:700;padding:14px;flex:1;cursor:pointer;font-family:inherit;letter-spacing:1px;text-transform:uppercase}
.db{background:#fff;border:1px solid #cc4444;border-radius:8px;color:#cc4444;font-size:13px;font-weight:700;padding:14px 16px;cursor:pointer;font-family:inherit;letter-spacing:1px;text-transform:uppercase}
.hb{width:100%;margin-top:4px;padding:14px;background:transparent;border:1px solid #bbb;border-radius:8px;color:#666;font-size:13px;font-family:inherit;cursor:pointer;letter-spacing:2px;text-transform:uppercase}
.hc{background:#f7f7f7;border:1px solid #ccc;border-radius:8px;padding:12px;margin-bottom:12px}
.hch{display:flex;justify-content:space-between;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid #ccc}
.hcdn{font-size:16px;font-weight:700;color:#111}
.hcdt{font-size:12px;color:#777}
.he{margin-bottom:6px}
.hen{font-size:13px;color:#555;margin-bottom:2px}
.hss{display:flex;gap:8px;flex-wrap:wrap}
.hst{font-size:12px;color:#555;background:#e8e8e8;padding:2px 6px;border-radius:3px}
.et{text-align:center;color:#999;font-size:14px;padding:40px}
.hidden{display:none}
.bodymap{position:relative;width:100%;max-width:320px;margin:0 auto}
.bodymap svg{width:100%;height:auto}
.mfield{position:absolute;display:flex;flex-direction:column;align-items:center}
.mfield label{font-size:10px;color:#555;font-weight:600;letter-spacing:0.5px;margin-bottom:2px;white-space:nowrap}
.mfield input{width:56px;background:#fff;border:1px solid #bbb;border-radius:4px;color:#111;font-size:14px;padding:6px 4px;text-align:center;font-family:inherit;outline:none}
.mfield input:focus{border-color:#1a6b1a}
.mline{position:absolute;pointer-events:none}
.savebar{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #ccc;padding:12px 16px;max-width:480px;margin:0 auto}
.savebtn{background:#e0f0e0;border:1px solid #80b880;border-radius:8px;color:#1a6b1a;font-size:14px;font-weight:700;padding:14px;width:100%;cursor:pointer;font-family:inherit;letter-spacing:1px;text-transform:uppercase}
.expbtn{background:#fff;border:1px solid #bbb;border-radius:8px;color:#666;font-size:12px;font-weight:600;padding:10px;width:100%;cursor:pointer;font-family:inherit;letter-spacing:1px;text-transform:uppercase;margin-top:8px}
.mhist{margin-top:20px}
.mhrow{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;font-size:12px;color:#555}
.mhrow.mhhead{font-weight:700;color:#333;border-bottom:2px solid #ccc}
.mhcell{flex:1;text-align:center}
.mhcell:first-child{text-align:left}
.toast{position:fixed;top:60px;left:50%;transform:translateX(-50%);background:#1a6b1a;color:#fff;padding:10px 24px;border-radius:8px;font-size:14px;font-weight:600;z-index:100;opacity:0;transition:opacity 0.3s}
.toast.show{opacity:1}
</style>
</head>
<body>
<div id="toast" class="toast"></div>
<div class="tabs">
  <div class="tab active" id="tab-rt" onclick="switchTab('rt')">RT Training</div>
  <div class="tab" id="tab-meas" onclick="switchTab('meas')">Measurements</div>
</div>
<div id="app"></div>
<script>
var PROGRAM = [
  {id:"day1",name:"Day 1",dayLabel:"Mon",exercises:[
    {id:"leg_press",name:"Leg Press",sets:3,pairLabel:"a"},
    {id:"glutes_1",name:"Glutes Machine",sets:3,pairLabel:"a"},
    {id:"leg_ext",name:"Leg Extension",sets:3,pairLabel:"b"},
    {id:"leg_curl",name:"Seated Leg Curl",sets:3,pairLabel:"b"},
    {id:"bicep_curl",name:"Bicep Curl (Cable)",sets:3,pairLabel:"c"},
    {id:"tri_push",name:"Triceps Pushdown",sets:3,pairLabel:"c"},
    {id:"chest_press",name:"Chest Press (Machine)",sets:3,pairLabel:null},
    {id:"lat_raise1",name:"Lateral Raise",sets:3,pairLabel:null}
  ]},
  {id:"day2",name:"Day 2",dayLabel:"Wed",exercises:[
    {id:"glutes_2",name:"Glutes Machine",sets:3,pairLabel:null},
    {id:"lat_pull",name:"Lat Pulldown",sets:3,pairLabel:null},
    {id:"hinge_row",name:"Hinge Row",sets:3,pairLabel:null},
    {id:"hammer_curl",name:"Hammer Curl",sets:3,pairLabel:null},
    {id:"landmine",name:"Landmine",sets:2,pairLabel:null},
    {id:"face_pull",name:"Face Pull",sets:3,pairLabel:null}
  ]},
  {id:"day3",name:"Day 3",dayLabel:"Sat",exercises:[
    {id:"bss",name:"Bulgarian Split Squat",sets:3,pairLabel:null},
    {id:"seated_row",name:"Seated Row",sets:3,pairLabel:null},
    {id:"incline_bench",name:"Incline Bench Press",sets:3,pairLabel:null},
    {id:"chest_fly",name:"Chest Fly",sets:3,pairLabel:null},
    {id:"plank",name:"Plank",sets:3,pairLabel:null}
  ]}
];

var MEAS_FIELDS = [
  {id:"chest",label:"Chest"},
  {id:"bicep_l",label:"Bicep L"},
  {id:"bicep_r",label:"Bicep R"},
  {id:"buttocks",label:"Buttocks"},
  {id:"quad_l",label:"Quad L"},
  {id:"quad_r",label:"Quad R"}
];

var workoutData={};
var historyData=[];
var notesData={};
var checkedSets={};
var collapsed={};
var measHistory=[];
var currentView="home";
var currentDay=null;
var currentTab="rt";
var timerInt=null;
var timerSec=0;
var openNotes={};

function loadStorage(){
  try{workoutData=JSON.parse(localStorage.getItem("ht-data"))||{};}catch(e){workoutData={};}
  try{historyData=JSON.parse(localStorage.getItem("ht-history"))||[];}catch(e){historyData=[];}
  try{notesData=JSON.parse(localStorage.getItem("ht-notes"))||{};}catch(e){notesData={};}
  try{checkedSets=JSON.parse(localStorage.getItem("ht-checked"))||{};}catch(e){checkedSets={};}
  try{measHistory=JSON.parse(localStorage.getItem("ht-meas"))||[];}catch(e){measHistory=[];}
}

function saveAll(){
  try{
    localStorage.setItem("ht-data",JSON.stringify(workoutData));
    localStorage.setItem("ht-history",JSON.stringify(historyData));
    localStorage.setItem("ht-notes",JSON.stringify(notesData));
    localStorage.setItem("ht-checked",JSON.stringify(checkedSets));
    localStorage.setItem("ht-meas",JSON.stringify(measHistory));
  }catch(e){}
}

function fmtDate(d){
  var days=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return days[d.getDay()]+" "+d.getDate()+" "+months[d.getMonth()]+" "+d.getFullYear();
}

function isoDate(d){
  var y=d.getFullYear();
  var m=d.getMonth()+1;if(m<10)m="0"+m;
  var day=d.getDate();if(day<10)day="0"+day;
  return y+"-"+m+"-"+day;
}

function esc(s){
  if(!s)return"";
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

function showToast(msg){
  var t=document.getElementById("toast");
  t.textContent=msg;
  t.className="toast show";
  setTimeout(function(){t.className="toast";},2000);
}

function switchTab(tab){
  currentTab=tab;
  document.getElementById("tab-rt").className=tab==="rt"?"tab active":"tab";
  document.getElementById("tab-meas").className=tab==="meas"?"tab active":"tab";
  if(tab==="rt"){
    currentView="home";currentDay=null;
  }
  render();
}

function getSet(dayId,exId,i){
  var k=dayId+"_"+exId;
  if(workoutData[k]&&workoutData[k][i])return workoutData[k][i];
  return{weight:"",reps:""};
}

function setSet(dayId,exId,i,field,val){
  var k=dayId+"_"+exId;
  if(!workoutData[k])workoutData[k]=[];
  if(!workoutData[k][i])workoutData[k][i]={weight:"",reps:""};
  workoutData[k][i][field]=val;
  saveAll();
}

function isChecked(dayId,exId,i){
  var k=dayId+"_"+exId+"_"+i;
  return checkedSets[k]===true;
}

function toggleCheck(dayId,exId,i){
  var k=dayId+"_"+exId+"_"+i;
  checkedSets[k]=!checkedSets[k];
  saveAll();
  render();
}

function allChecked(dayId,exId,numSets){
  for(var i=0;i<numSets;i++){
    if(!isChecked(dayId,exId,i))return false;
  }
  return true;
}

function toggleCollapse(dayId,exId){
  var k=dayId+"_"+exId;
  collapsed[k]=!collapsed[k];
  render();
}

function isCollapsed(dayId,exId){
  return collapsed[dayId+"_"+exId]===true;
}

function setNote(exId,val){
  notesData[exId]=val;
  saveAll();
}

function toggleN(exId){
  openNotes[exId]=!openNotes[exId];
  render();
  if(openNotes[exId]){
    setTimeout(function(){
      var el=document.getElementById("note-"+exId);
      if(el)el.focus();
    },100);
  }
}

function closeN(exId){
  var el=document.getElementById("note-"+exId);
  if(el)setNote(exId,el.value);
  openNotes[exId]=false;
  render();
}

function getLastPerf(exId){
  var base=exId.replace(/_\d+$/,"");
  for(var i=0;i<historyData.length;i++){
    var e=historyData[i];
    var keys=Object.keys(e.exercises);
    for(var j=0;j<keys.length;j++){
      var k=keys[j];
      if(k===exId||k.replace(/_\d+$/,"")===base){
        return{date:e.date,sets:e.exercises[k].sets};
      }
    }
  }
  return null;
}

function getLastDate(dayId){
  for(var i=0;i<historyData.length;i++){
    if(historyData[i].dayId===dayId)return historyData[i].date;
  }
  return null;
}

function finish(dayId){
  var day=null;
  for(var i=0;i<PROGRAM.length;i++){if(PROGRAM[i].id===dayId)day=PROGRAM[i];}
  var entry={date:fmtDate(new Date()),dayId:dayId,dayName:day.name,exercises:{}};
  for(var i=0;i<day.exercises.length;i++){
    var ex=day.exercises[i];
    var k=dayId+"_"+ex.id;
    if(workoutData[k]){
      var filled=[];
      for(var j=0;j<workoutData[k].length;j++){
        var s=workoutData[k][j];
        if(s&&(s.weight||s.reps))filled.push(s);
      }
      if(filled.length)entry.exercises[ex.id]={name:ex.name,sets:filled};
    }
  }
  historyData.unshift(entry);
  if(historyData.length>100)historyData=historyData.slice(0,100);
  for(var i=0;i<day.exercises.length;i++){
    var ek=dayId+"_"+day.exercises[i].id;
    delete workoutData[ek];
    for(var j=0;j<day.exercises[i].sets;j++){
      delete checkedSets[ek+"_"+j];
    }
    delete collapsed[ek];
  }
  saveAll();
  stopT();
  currentView="home";currentDay=null;
  render();
}

function delWorkout(dayId){
  if(!confirm("Delete current workout data?"))return;
  var day=null;
  for(var i=0;i<PROGRAM.length;i++){if(PROGRAM[i].id===dayId)day=PROGRAM[i];}
  for(var i=0;i<day.exercises.length;i++){
    var ek=dayId+"_"+day.exercises[i].id;
    delete workoutData[ek];
    for(var j=0;j<day.exercises[i].sets;j++){
      delete checkedSets[ek+"_"+j];
    }
    delete collapsed[ek];
  }
  saveAll();
  stopT();
  currentView="home";currentDay=null;
  render();
}

function startT(secs){
  stopT();
  timerSec=secs;
  renderT();
  timerInt=setInterval(function(){
    timerSec--;
    if(timerSec<=0)stopT();
    renderT();
  },1000);
}

function stopT(){
  if(timerInt){clearInterval(timerInt);timerInt=null;}
  timerSec=0;
  var el=document.getElementById("tbar");
  if(el)el.className="tb hidden";
}

function renderT(){
  var el=document.getElementById("tbar");
  if(!el)return;
  if(timerSec>0){
    el.className="tb";
    var m=Math.floor(timerSec/60);
    var s=timerSec%60;
    if(s<10)s="0"+s;
    el.querySelector(".tt").textContent="Rest: "+m+":"+s;
  }else{
    el.className="tb hidden";
  }
}

function goDay(dayId){currentDay=dayId;currentView="workout";render();}
function goHome(){currentView="home";currentDay=null;stopT();render();}
function goHist(){currentView="history";render();}

function saveMeas(){
  var entry={date:isoDate(new Date())};
  var hasData=false;
  for(var i=0;i<MEAS_FIELDS.length;i++){
    var el=document.getElementById("meas-"+MEAS_FIELDS[i].id);
    var val=el?el.value.trim():"";
    entry[MEAS_FIELDS[i].id]=val;
    if(val)hasData=true;
  }
  if(!hasData){alert("Enter at least one measurement.");return;}
  measHistory.unshift(entry);
  if(measHistory.length>200)measHistory=measHistory.slice(0,200);
  saveAll();
  showToast("Measurements saved!");
  render();
}

function exportMeasCSV(){
  var header="Date,Chest,Bicep L,Bicep R,Buttocks,Quad L,Quad R\n";
  var rows="";
  for(var i=0;i<measHistory.length;i++){
    var e=measHistory[i];
    rows+=e.date+","+(e.chest||"")+","+(e.bicep_l||"")+","+(e.bicep_r||"")+","+(e.buttocks||"")+","+(e.quad_l||"")+","+(e.quad_r||"")+"\n";
  }
  var blob=new Blob([header+rows],{type:"text/csv"});
  var url=URL.createObjectURL(blob);
  var a=document.createElement("a");
  a.href=url;
  a.download="measurements.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function render(){
  var app=document.getElementById("app");
  if(currentTab==="meas"){renderMeas(app);return;}
  if(currentView==="home")renderHome(app);
  else if(currentView==="workout")renderWO(app);
  else if(currentView==="history")renderHist(app);
}

function renderHome(app){
  var h='<div class="page"><div class="hh"><div class="ht">HELGE</div><div class="hs">TRAINING LOG</div><div class="hd">'+fmtDate(new Date())+'</div></div>';
  for(var d=0;d<PROGRAM.length;d++){
    var day=PROGRAM[d];
    var hasData=false;
    for(var i=0;i<day.exercises.length;i++){
      if(workoutData[day.id+"_"+day.exercises[i].id]){hasData=true;break;}
    }
    var pairs={};
    for(var i=0;i<day.exercises.length;i++){
      if(day.exercises[i].pairLabel)pairs[day.exercises[i].pairLabel]=true;
    }
    var pairCount=Object.keys(pairs).length;
    var exList="";
    for(var i=0;i<day.exercises.length;i++){
      var ex=day.exercises[i];
      var icon=ex.pairLabel?'<span class="pi">\u2194</span>':"";
      exList+='<div class="dce">'+icon+ex.name+'</div>';
    }
    var pairLine=pairCount?'<div class="pinfo">'+pairCount+" antagonist pair"+(pairCount>1?"s":"")+"</div>":"";
    var prog=hasData?'<div class="inp">In progress</div>':"";
    var ld=getLastDate(day.id);
    var ldLine=ld?'<div class="lwd">Last: '+ld+'</div>':"";
    h+='<div class="dc" onclick="goDay(\''+day.id+'\')"><div class="dch"><span class="dcn">'+day.name+'</span><span class="dcl">'+day.dayLabel+'</span></div>'+exList+pairLine+prog+ldLine+'</div>';
  }
  h+='<div class="hb" onclick="goHist()">View History</div></div>';
  app.innerHTML=h;
}

function renderWO(app){
  var day=null;
  for(var i=0;i<PROGRAM.length;i++){if(PROGRAM[i].id===currentDay)day=PROGRAM[i];}
  var today=fmtDate(new Date());
  var h='<div class="page"><div class="hdr"><button class="bb" onclick="goHome()">\u2190 Back</button><div class="pt">'+day.name+' <span class="dt">'+day.dayLabel+'</span></div><div class="wd">'+today+'</div></div>';
  h+='<div id="tbar" class="tb hidden"><span class="tt"></span><button class="tc" onclick="stopT()">\u2715</button></div>';

  for(var i=0;i<day.exercises.length;i++){
    var ex=day.exercises[i];
    var pc=ex.pairLabel?"p"+ex.pairLabel:"";
    var allDone=allChecked(day.id,ex.id,ex.sets);
    var coll=isCollapsed(day.id,ex.id);

    if(allDone&&coll){
      var sumParts=[];
      for(var j=0;j<ex.sets;j++){
        var sd=getSet(day.id,ex.id,j);
        if(sd.weight||sd.reps){
          sumParts.push(sd.weight+"\u00d7"+sd.reps);
        }
      }
      var badge=ex.pairLabel?'<span class="pbg '+ex.pairLabel+'">'+ex.pairLabel.toUpperCase()+'</span>':"";
      h+='<div class="ec done collapsed '+pc+'" onclick="toggleCollapse(\''+day.id+"','"+ex.id+"')\">";
      h+='<div class="cline">'+badge+'<span class="en">'+ex.name+'</span>';
      for(var j=0;j<sumParts.length;j++){
        h+='<span class="ctag">'+sumParts[j]+'</span>';
      }
      h+='<span class="carrow">\u25BC</span></div></div>';
      continue;
    }

    var doneClass=allDone?" done":"";
    var badge=ex.pairLabel?'<span class="pbg '+ex.pairLabel+'">'+ex.pairLabel.toUpperCase()+'</span>':"";
    var last=getLastPerf(ex.id);
    var prevHtml="";
    if(last){
      prevHtml='<div class="lp">Prev ('+last.date+'):</div><div class="ps">';
      for(var j=0;j<last.sets.length;j++){
        prevHtml+='<span class="pst">'+last.sets[j].weight+'kg \u00d7 '+last.sets[j].reps+'</span>';
      }
      prevHtml+='</div>';
    }
    var noteVal=notesData[ex.id]||"";
    var isOpen=openNotes[ex.id];
    var noteHtml="";
    if(isOpen){
      noteHtml='<div class="nr"><textarea id="note-'+ex.id+'" class="ni" placeholder="e.g. squeeze at top..." onblur="closeN(\''+ex.id+'\')">'+esc(noteVal)+'</textarea></div>';
    }else if(noteVal){
      noteHtml='<div class="nr"><div class="nd" onclick="toggleN(\''+ex.id+'\')">'+esc(noteVal)+'</div></div>';
    }else{
      noteHtml='<div class="nr"><button class="nt" onclick="toggleN(\''+ex.id+'\')">+ note</button></div>';
    }

    var setsHtml="";
    for(var j=0;j<ex.sets;j++){
      var sd=getSet(day.id,ex.id,j);
      var chk=isChecked(day.id,ex.id,j);
      var rowClass=chk?"sr checked":"sr";
      setsHtml+='<div class="'+rowClass+'"><span class="sn">'+(j+1)+'</span><input class="si" type="number" inputmode="decimal" placeholder="kg" value="'+sd.weight+'" onchange="setSet(\''+day.id+"','"+ex.id+"',"+j+",'weight',this.value)\"><span class=\"ss\">\u00d7</span><input class=\"si\" type=\"number\" inputmode=\"numeric\" placeholder=\"reps\" value=\""+sd.reps+"\" onchange=\"setSet('"+day.id+"','"+ex.id+"',"+j+",'reps',this.value)\"><input type=\"checkbox\" class=\"cb\""+(chk?" checked":"")+" onchange=\"toggleCheck('"+day.id+"','"+ex.id+"',"+j+")\"></div>";
    }
    if(allDone){
      setsHtml+='<div style="text-align:right;margin-top:4px"><button style="background:none;border:none;color:#1a6b1a;font-size:12px;cursor:pointer;font-family:inherit" onclick="toggleCollapse(\''+day.id+"','"+ex.id+"')\">Collapse \u25B2</button></div>";
    }

    h+='<div class="ec '+pc+doneClass+'"><div class="enr">'+badge+'<span class="en">'+ex.name+'</span></div>'+prevHtml+noteHtml+setsHtml+'</div>';
  }

  h+='<div class="bar"><div class="tbs"><button class="tbtn" onclick="startT(60)">1:00</button><button class="tbtn" onclick="startT(90)">1:30</button><button class="tbtn" onclick="startT(120)">2:00</button><button class="tbtn" onclick="startT(180)">3:00</button></div><div class="brow"><button class="fb" onclick="finish(\''+day.id+'\')">Finish Workout</button><button class="db" onclick="delWorkout(\''+day.id+'\')">Del</button></div></div></div>';
  app.innerHTML=h;
}

function renderHist(app){
  var h='<div class="page"><div class="hdr"><button class="bb" onclick="goHome()">\u2190 Back</button><div class="pt">History</div></div>';
  if(!historyData.length){
    h+='<div class="et">No workouts logged yet</div>';
  }else{
    for(var i=0;i<historyData.length;i++){
      var entry=historyData[i];
      var exHtml="";
      var keys=Object.keys(entry.exercises);
      for(var j=0;j<keys.length;j++){
        var ex=entry.exercises[keys[j]];
        var sts="";
        for(var k=0;k<ex.sets.length;k++){
          sts+='<span class="hst">'+ex.sets[k].weight+'kg \u00d7 '+ex.sets[k].reps+'</span>';
        }
        exHtml+='<div class="he"><div class="hen">'+ex.name+'</div><div class="hss">'+sts+'</div></div>';
      }
      h+='<div class="hc"><div class="hch"><span class="hcdn">'+entry.dayName+'</span><span class="hcdt">'+entry.date+'</span></div>'+exHtml+'</div>';
    }
  }
  h+='</div>';
  app.innerHTML=h;
}

function renderMeas(app){
  var lastEntry=measHistory.length?measHistory[0]:{};
  var h='<div class="page">';
  h+='<div style="text-align:center;margin-bottom:8px"><div style="font-size:18px;font-weight:700;color:#000">Body Measurements</div><div style="font-size:12px;color:#777;margin-top:4px">'+fmtDate(new Date())+' \u2022 cm</div></div>';

  h+='<div class="bodymap" style="height:460px">';

  // SVG male back outline
  h+='<svg viewBox="0 0 200 400" style="position:absolute;left:50%;transform:translateX(-50%);width:180px;height:360px;top:20px">';
  // Head
  h+='<ellipse cx="100" cy="28" rx="18" ry="22" fill="none" stroke="#ccc" stroke-width="1.5"/>';
  // Neck
  h+='<line x1="92" y1="50" x2="92" y2="62" stroke="#ccc" stroke-width="1.5"/>';
  h+='<line x1="108" y1="50" x2="108" y2="62" stroke="#ccc" stroke-width="1.5"/>';
  // Shoulders & torso
  h+='<path d="M92,62 L60,75 L48,95 L45,140 L50,175 L55,190 L65,195 L80,190 L90,185 L100,183 L110,185 L120,190 L135,195 L145,190 L150,175 L155,140 L152,95 L140,75 L108,62" fill="none" stroke="#bbb" stroke-width="1.5"/>';
  // Spine line
  h+='<line x1="100" y1="62" x2="100" y2="183" stroke="#ddd" stroke-width="0.8" stroke-dasharray="3,3"/>';
  // Glutes
  h+='<path d="M80,190 Q75,210 78,225 Q85,235 100,235 Q115,235 122,225 Q125,210 120,190" fill="none" stroke="#bbb" stroke-width="1.5"/>';
  h+='<line x1="100" y1="190" x2="100" y2="235" stroke="#ddd" stroke-width="0.8" stroke-dasharray="3,3"/>';
  // Left leg
  h+='<path d="M78,225 Q72,260 70,295 Q69,320 72,350 Q74,370 78,385" fill="none" stroke="#bbb" stroke-width="1.5"/>';
  h+='<path d="M100,235 Q95,260 92,295 Q91,320 90,350 Q89,370 88,385" fill="none" stroke="#bbb" stroke-width="1.5"/>';
  // Right leg
  h+='<path d="M122,225 Q128,260 130,295 Q131,320 128,350 Q126,370 122,385" fill="none" stroke="#bbb" stroke-width="1.5"/>';
  h+='<path d="M100,235 Q105,260 108,295 Q109,320 110,350 Q111,370 112,385" fill="none" stroke="#bbb" stroke-width="1.5"/>';
  // Left arm
  h+='<path d="M48,95 Q38,120 35,145 Q33,165 36,185 Q38,200 40,210" fill="none" stroke="#bbb" stroke-width="1.5"/>';
  h+='<path d="M60,75 Q55,95 52,120 Q50,140 52,160 Q54,180 55,195" fill="none" stroke="#bbb" stroke-width="1.5"/>';
  // Right arm
  h+='<path d="M152,95 Q162,120 165,145 Q167,165 164,185 Q162,200 160,210" fill="none" stroke="#bbb" stroke-width="1.5"/>';
  h+='<path d="M140,75 Q145,95 148,120 Q150,140 148,160 Q146,180 145,195" fill="none" stroke="#bbb" stroke-width="1.5"/>';
  h+='</svg>';

  // Measurement fields positioned around the body
  // Chest - top center
  h+='<div class="mfield" style="top:95px;left:50%;transform:translateX(-50%)">';
  h+='<label>Chest</label>';
  h+='<input type="number" inputmode="decimal" id="meas-chest" placeholder="-" value="'+(lastEntry.chest||"")+'">';
  h+='</div>';

  // Bicep L - left side
  h+='<div class="mfield" style="top:130px;left:2px">';
  h+='<label>Bicep L</label>';
  h+='<input type="number" inputmode="decimal" id="meas-bicep_l" placeholder="-" value="'+(lastEntry.bicep_l||"")+'">';
  h+='</div>';

  // Bicep R - right side
  h+='<div class="mfield" style="top:130px;right:2px">';
  h+='<label>Bicep R</label>';
  h+='<input type="number" inputmode="decimal" id="meas-bicep_r" placeholder="-" value="'+(lastEntry.bicep_r||"")+'">';
  h+='</div>';

  // Buttocks - center
  h+='<div class="mfield" style="top:230px;left:50%;transform:translateX(-50%)">';
  h+='<label>Buttocks</label>';
  h+='<input type="number" inputmode="decimal" id="meas-buttocks" placeholder="-" value="'+(lastEntry.buttocks||"")+'">';
  h+='</div>';

  // Quad L - lower left
  h+='<div class="mfield" style="top:330px;left:12px">';
  h+='<label>Quad L</label>';
  h+='<input type="number" inputmode="decimal" id="meas-quad_l" placeholder="-" value="'+(lastEntry.quad_l||"")+'">';
  h+='</div>';

  // Quad R - lower right
  h+='<div class="mfield" style="top:330px;right:12px">';
  h+='<label>Quad R</label>';
  h+='<input type="number" inputmode="decimal" id="meas-quad_r" placeholder="-" value="'+(lastEntry.quad_r||"")+'">';
  h+='</div>';

  h+='</div>'; // end bodymap

  // History table
  if(measHistory.length){
    h+='<div class="mhist">';
    h+='<div style="font-size:14px;font-weight:700;color:#333;margin-bottom:8px">History</div>';
    h+='<div style="overflow-x:auto"><div style="min-width:380px">';
    h+='<div class="mhrow mhhead"><div class="mhcell">Date</div><div class="mhcell">Chest</div><div class="mhcell">Bi L</div><div class="mhcell">Bi R</div><div class="mhcell">Butt</div><div class="mhcell">Qu L</div><div class="mhcell">Qu R</div></div>';
    for(var i=0;i<measHistory.length&&i<20;i++){
      var e=measHistory[i];
      h+='<div class="mhrow"><div class="mhcell">'+e.date+'</div><div class="mhcell">'+(e.chest||"-")+'</div><div class="mhcell">'+(e.bicep_l||"-")+'</div><div class="mhcell">'+(e.bicep_r||"-")+'</div><div class="mhcell">'+(e.buttocks||"-")+'</div><div class="mhcell">'+(e.quad_l||"-")+'</div><div class="mhcell">'+(e.quad_r||"-")+'</div></div>';
    }
    h+='</div></div></div>';
  }

  h+='<div class="savebar"><button class="savebtn" onclick="saveMeas()">Save Measurements</button><button class="expbtn" onclick="exportMeasCSV()">Export CSV</button></div>';
  h+='</div>';
  app.innerHTML=h;
}

loadStorage();
render();
</script>
</body>
</html>
